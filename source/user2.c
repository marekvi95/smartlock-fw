/*
 * user2.c
 *
 *  Created on: May 14, 2020
 *      Author: nxf46245
 */

#include <stdio.h>
#include <stdint.h>
#include <string.h>

#define USERS 32
#define MIFARE_SIZE 6
#define UID_SIZE 4
#define KEY_SIZE 16

#define print_buf(x,y,z)  {int loop; printf(x); for(loop=0;loop<z;loop++) printf("%.2x ", y[loop]); printf("\n");}

typedef struct {
	unsigned char mifareKey[MIFARE_SIZE];
	unsigned char authKey[KEY_SIZE];
	unsigned char uid[UID_SIZE];
} user_t;

user_t arr_user[USERS];
unsigned char i = 0;
user_t (*user_array_ptr)[];

const unsigned char default_mifare[MIFARE_SIZE] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff};
const unsigned char default_uid[UID_SIZE] = {0x00, 0x00, 0x00, 0x00};
const unsigned char master_uid[UID_SIZE] = {0x45, 0x75, 0x65, 0x2a};
const unsigned char master_key[KEY_SIZE] = {
		0x42, 0x54, 0x69, 0x63,
		0x69, 0x6e, 0x6f, 0x43,
		0x41, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00};

const unsigned char default_keys[USERS][KEY_SIZE] = {
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
		{0x3e, 0x83, 0x7a, 0xee, 0x93, 0x14, 0xdf, 0xb, 0x12, 0xe, 0xd4, 0x12, 0x56, 0xcf, 0x9a, 0x51},
		{0x43, 0x58, 0x69, 0x4d, 0xe6, 0x97, 0x21, 0xbb, 0xd2, 0x78, 0x83, 0xf4, 0x98, 0xc3, 0xfa, 0xc9},
		{0xd9, 0xce, 0x18, 0x3a, 0x94, 0xf3, 0x25, 0xe5, 0xec, 0xfd, 0x2a, 0x70, 0xc5, 0xe8, 0x5d, 0x9f},
		{0xd3, 0x4, 0xec, 0x5a, 0xde, 0xc4, 0xb7, 0x36, 0xd, 0xa9, 0xc3, 0x69, 0x97, 0x53, 0x58, 0x14},
};

void initDB(user_t (*user_array_ptr)[])
{
	memcpy((*user_array_ptr)[0].mifareKey, default_mifare, MIFARE_SIZE);
	memcpy((*user_array_ptr)[0].authKey, master_key, KEY_SIZE);
	memcpy((*user_array_ptr)[0].uid, master_uid, UID_SIZE);

	for (i=1; i<USERS; i++)
	{
		memcpy((*user_array_ptr)[i].mifareKey, default_mifare, MIFARE_SIZE);
		memcpy((*user_array_ptr)[i].authKey, default_keys[i], KEY_SIZE);
		memcpy((*user_array_ptr)[i].uid, default_uid, UID_SIZE);
	}
}

void printDB(user_t (*user_array_ptr)[])
{
	for (i=0; i<USERS; i++)
	{
		printf("Mifare Key: ");
		print_buf(" ", (*user_array_ptr)[i].mifareKey, MIFARE_SIZE);
		printf("authKey: ");
		print_buf(" ", (*user_array_ptr)[i].authKey, KEY_SIZE);
		printf("UID: ");
		print_buf(" ", (*user_array_ptr)[i].uid, UID_SIZE);
	}
}

uint8_t insertUser(user_t (*user_array_ptr)[], const unsigned char * uid)
{
	for (i=1; i<USERS; i++)
	{
		if (memcmp((*user_array_ptr)[i].uid, uid, UID_SIZE) == 0)
		{
			printf("UID already in DB\n");
			return -1;
		}
		else if(memcmp((*user_array_ptr)[i].uid, default_uid, UID_SIZE) == 0)
		{
			memcpy((*user_array_ptr)[i].uid, uid, UID_SIZE);
			return 0;
		}
	}
}

uint8_t getAuth(unsigned char* uid, unsigned char* authKey, char* name)
{
	for(int i=0; i<USERS; i++)
	{
		if (memcmp(arr_user[i].uid, uid, UID_SIZE) == 0)
		{
            memcpy(name, arr_user[i].name, NAME_SIZE);
            memcpy(authKey, arr_user[i].authKey, KEY_SIZE);
			return 1;
		}
	}
	return 0;
}


int main()
{
	user_array_ptr = &arr_user;
	const unsigned char uid1[UID_SIZE] = {0x10, 0x20, 0x30, 0x40};
	printf("size of arr_user: %lu\n", sizeof(arr_user));

	initDB(&arr_user);
	insertUser(&arr_user, uid1);
	insertUser(&arr_user, uid1);
	printDB(&arr_user);

	return 0;
}

